<div class="container">
    <form id="textForm" action="regist" method="post">
        <!-- 入力欄 -->
        <div class="form-group row align-items-center">
            <label class="col-sm-2 col-form-label">社名</label>
            <div class="col-sm-10 dropdown position-relative">
                <input type="text" class="form-control form-control-sm input-mid dropdown-toggle" id="company" autocomplete="off" data-bs-toggle="dropdown" name="companyName" th:value="${companyName}">
                <ul class="dropdown-menu w-100" id="companyList"></ul>
            </div>
        </div>

        <div class="form-group row align-items-center">
            <label class="col-sm-2 col-form-label">氏名</label>
            <div class="col-sm-4 dropdown position-relative">
                <input type="text" class="form-control form-control-sm input-small dropdown-toggle" id="name" autocomplete="off" data-bs-toggle="dropdown" name="personName" th:value="${personName}">
                <ul class="dropdown-menu w-100" id="nameList"></ul>
            </div>
            <label class="col-sm-2 col-form-label">役職</label>
            <div class="col-sm-4">
                <select class="form-control form-control-sm" id="position" name="honolific">
                    <option value="" selected>選択してください</option>
                    <option>様</option>
                    <option>さん</option>
                    <option>主任</option>
                    <option>上級主任</option>
                    <option>課長</option>
                    <option>所長</option>
                </select>
            </div>
        </div>

        <div class="form-group row align-items-center">
            <label class="col-sm-2 col-form-label">電話番号</label>
            <div class="col-sm-10 dropdown position-relative d-flex align-items-center">
                <input type="text" class="form-control form-control-sm input-mid dropdown-toggle" id="phone" autocomplete="off" data-bs-toggle="dropdown" name="telNumber" th:value="${telNumber}">
                <ul class="dropdown-menu w-100" id="phoneList"></ul>
				<!-- リストに登録ボタン -->
                <button type="submit" class="btn btn-primary btn-sm ml-5" id="addListBtn">リストに登録</button>
				<!-- 登録ボタンで登録した時に結果を格納 1→登録成功、2→登録失敗 -->
				<input type="hidden" th:value="${registResult}" id="registResult">
            </div>
        </div>

        <!-- ラジオ選択 -->
        <fieldset class="form-group">
            <legend>こちらの状態</legend>
            <label class="mr-3"><input type="radio" name="myState" value="不在"> 不在</label>
            <label class="mr-3"><input type="radio" name="myState" value="離席中"> 離席中</label>
            <label><input type="radio" name="myState" value="対応中"> 対応中</label>
        </fieldset>

        <fieldset class="form-group">
            <legend>相手の対応</legend>
            <label class="mr-3"><input type="radio" name="resp" value="改めて掛け直す"> 掛け直す</label>
            <label class="mr-3"><input type="radio" name="resp" value="折り返し電話希望"> 折り返し希望</label>
            <label><input type="radio" name="resp" value="メールを送る"> メール送る</label>
        </fieldset>

        <!-- 文章作成 + コピー -->
        <div class="d-flex align-items-center mb-2 position-relative button-row">
            <div class="mx-auto">
                <button type="submit" class="btn btn-primary btn-sm" id="createBtn" style="min-width:120px;">文章作成</button>
            </div>
            <button type="button" class="btn btn-success btn-sm" id="copyBtn" style="min-width:100px; position:absolute; right:0;">コピー</button>
        </div>

        <textarea id="result" class="form-control result-box" name="result" th:text="${result}"></textarea>

        <div class="d-flex justify-content-end mt-1">
            <button type="button" class="btn btn-secondary btn-sm" id="resetBtn" style="min-width:80px;">リセット</button>
        </div>

		<!--	 登録処理が自動か手動か 1→手動、2→自動 -->
		<input type="hidden" th:value="${registMode}" id="registMode" name="registMode">
    </form>
</div>

<script>
// ラジオ選択解除
function makeRadioToggleable(radios) {
    radios.forEach(radio => {
        radio.addEventListener('click', function() {
            if (radio.wasChecked) {
                radio.checked = false;
                radio.wasChecked = false;
            } else {
                radios.forEach(r => r.wasChecked = false);
                radio.wasChecked = radio.checked;
            }
        });
    });
}
makeRadioToggleable(document.querySelectorAll('input[name="myState"]'));
makeRadioToggleable(document.querySelectorAll('input[name="resp"]'));

// リスト登録ボタン
document.getElementById('addListBtn').addEventListener('click', (e)=>{
	// 登録処理を手動に設定
	document.getElementById('registMode').value = 1;
	const company = document.getElementById('company').value;
	const name = document.getElementById('name').value;
	const position = document.getElementById('position').value;
	const phone = document.getElementById('phone').value;
	// 会社名に TB が含まれるか（大文字小文字対応）
	const isTB = company.toUpperCase().includes("TB");

	// ★追加：電話番号が全角ハイフンのみかどうか
	const isFullWidthHyphenOnly = /^[ー]+$/.test(phone);

	// 登録処理を自動に設定
	document.getElementById('registMode').value = 2;

	// --- 未入力チェック ---
	const missing = [];
	if (!company) missing.push('社名');
	if (!name) missing.push('氏名');
	if (!position) missing.push('役職');

	// TB以外 → 電話番号必須
	// ★修正：TB以外 → 全角ハイフンのみ も 未入力扱い
	    if (!isTB && (!phone || isFullWidthHyphenOnly)) {
	        missing.push('電話番号');
	    }

	if (missing.length > 0) {
	    alert(missing.join('、') + 'を入力してください.');
		e.preventDefault();
	    return;
	}
});

window.addEventListener('load', () =>{
	const registResult = document.getElementById('registResult').value;
	if(registResult == 1){
		// 登録処理成功
        alert("相手先情報を登録しました"); 
        return;
    } else if (registResult == 2) {
		// 登録処理失敗
		alert("すでに登録されています");
		return;
	}
	return;
})

// 文章作成
document.getElementById('createBtn').addEventListener('click', (e) => {
    const company = document.getElementById('company').value;
    const name = document.getElementById('name').value;
    const position = document.getElementById('position').value;
    const phone = document.getElementById('phone').value;

    const myState = document.querySelector('input[name="myState"]:checked')?.value || '';
    const resp = document.querySelector('input[name="resp"]:checked')?.value || '';

    // 会社名に TB が含まれるか（大文字小文字対応）
    const isTB = company.toUpperCase().includes("TB");
	
	// ★追加：電話番号が全角ハイフンのみかどうか
	const isFullWidthHyphenOnly = /^[ー]+$/.test(phone);
		
	// 登録処理を自動に設定
	document.getElementById('registMode').value = 2;

    // --- 未入力チェック ---
    const missing = [];
    if (!company) missing.push('社名');
    if (!name) missing.push('氏名');
    if (!position) missing.push('役職');

    // TB以外 → 電話番号必須
	// ★修正：TB以外 → 全角ハイフンのみ も 未入力扱い
	    if (!isTB && (!phone || isFullWidthHyphenOnly)) {
	        missing.push('電話番号');
	    }

    if (missing.length > 0) {
        alert(missing.join('、') + 'を入力してください.');
		e.preventDefault();
        return;
    }

    // --- テキストエリアへの反映 ---
    const now = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

	// ★変更：全角ハイフンだけのときは出力しない
	    const phoneLine = (phone && !isFullWidthHyphenOnly) ? `【電話番号】 ${phone}\n` : "";

    document.getElementById('result').value =
`【相手先】 ${company} ${name} ${position} ${now}
${phoneLine}【内容】${myState || resp ? '\n' : ''}${myState ? myState + 'の旨をお伝えしたところ、' : ''}${resp ? resp + 'とのことでした。' : ''}`;

    
});


// リセット
document.getElementById('resetBtn').addEventListener('click', ()=>{
	// テキストボックスを空白に
	document.getElementById('company').value='';
	document.getElementById('name').value='';
	document.getElementById('phone').value='';
	document.getElementById('result').value='';
	
	// 役職セレクトボックスを初期化
	const positionSelect = document.getElementById('position');
	// 現在の選択肢をクリア
	positionSelect.innerHTML = "";
	// TB 以外 → 「様」1つだけ・選択不可
	const option = document.createElement("option");
	option.textContent = "様";
	option.value = "様";
	positionSelect.appendChild(option);
	positionSelect.disabled = true;
	
	// ラジオボタンの選択を解除
	document.querySelectorAll('input[name="myState"]').forEach(el => el.checked = false);
	document.querySelectorAll('input[name="resp"]').forEach(el => el.checked = false);
});

// コピー
document.getElementById('copyBtn').addEventListener('click', ()=>{
    const resultArea = document.getElementById('result');
    resultArea.select();
    document.execCommand('copy');
});

// -------------------
// サジェスト機能（1項目のみ表示、他は閉じる）
// -------------------
['company','name','phone'].forEach(id=>{
    const input = document.getElementById(id);
    const list = document.getElementById(id+'List');

    const fetchAndShow = async ()=>{
        // 他のサジェストを閉じる
        document.querySelectorAll('.dropdown-menu').forEach(l=>{
            if(l!==list){
                l.innerHTML='';
                l.classList.remove('show');
            }
        });

        list.innerHTML='';

        const query = {};
        if(document.getElementById('company').value.trim() && id!=='company')
            query.companyName = document.getElementById('company').value.trim();
        if(document.getElementById('name').value.trim() && id!=='name')
            query.personName = document.getElementById('name').value.trim();
        if(document.getElementById('phone').value.trim() && id!=='phone')
            query.telNumber = document.getElementById('phone').value.trim();

        if(input.value.trim()!=='') 
            query[id==='company'?'companyName':id==='name'?'personName':'telNumber'] = input.value.trim();

        const res = await fetch(`/api/tellist?${new URLSearchParams(query).toString()}`);
        const results = await res.json();
        const values = [...new Set(results.map(r=>id==='company'?r.companyName:id==='name'?r.personName:r.telNumber))];

        values.forEach(val=>{
            const li = document.createElement('button');
            li.type='button';
            li.className='dropdown-item';
            li.textContent = val;
            li.addEventListener('click', ()=>{
                input.value = val;
                list.innerHTML='';
                list.classList.remove('show');

				// 追加：役職の状態を更新（TB判定）
			    if (id === "company") {
			        updatePositionOptions();
			    }
            });
            list.appendChild(li);
        });

        if(values.length>0) list.classList.add('show');
        else list.classList.remove('show');
    };

    input.addEventListener('input', fetchAndShow);
    input.addEventListener('focus', fetchAndShow);
});

// クリック外で全て閉じる
document.addEventListener('click', e=>{
    if(!e.target.closest('.dropdown')){
        document.querySelectorAll('.dropdown-menu').forEach(list=>{
            list.innerHTML='';
            list.classList.remove('show');
        });
    }
});

// ドロップダウン内クリックは閉じない
document.querySelectorAll('.dropdown-menu').forEach(list=>{
    list.addEventListener('click', e=>e.stopPropagation());
});

const companyInput = document.getElementById('company');
const positionSelect = document.getElementById('position');
// hidden inputを準備（最初は存在しないので後で追加）
let hiddenHonolific = null;

// 役職の候補
const TB_OPTIONS = ["様", "さん", "主任", "上級主任", "課長", "所長"];
const DEFAULT_OPTION = ["様"]; // TB 以外はこれだけ

function updatePositionOptions() {
    const value = companyInput.value.trim().toUpperCase();

    const isTB = value.includes("TB");

    // 現在の選択肢をクリア
    positionSelect.innerHTML = "";

    if (isTB) {
        // TB → 全候補を追加・選択可能
        TB_OPTIONS.forEach(opt => {
            const option = document.createElement("option");
            option.textContent = opt;
            option.value = opt;
            positionSelect.appendChild(option);
        });

        positionSelect.disabled = false;

		// hiddenがあれば削除
        if (hiddenHonolific) {
            hiddenHonolific.remove();
            hiddenHonolific = null;
        }

    } else {
        // TB 以外 → 「様」1つだけ・選択不可
        const option = document.createElement("option");
        option.textContent = "様";
        option.value = "様";
        positionSelect.appendChild(option);

        positionSelect.disabled = true;

		// hidden inputを追加（まだなければ）
	    if (!hiddenHonolific) {
	        hiddenHonolific = document.createElement("input");
	        hiddenHonolific.type = "hidden";
	        hiddenHonolific.name = "honolific";
	        hiddenHonolific.value = "ー"; // DB登録用の値
	        positionSelect.parentNode.appendChild(hiddenHonolific);
	    }
    }
}

// 社名入力のたびに実行
companyInput.addEventListener("input", updatePositionOptions);

// 初期表示時
window.addEventListener("DOMContentLoaded", updatePositionOptions);
</script>
