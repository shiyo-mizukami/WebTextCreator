<!--編集モーダル-->
<head>
	<link rel="stylesheet" href="/modal.css">
</head>
<div class="edit_modal" id="edit_modal">
	<div class="modal_content">
		<button type="button" class="close" data-dismiss="modal"></button>
		<div class="modal-body pointer-auto">
			<!-- 変更前情報 -->
			<div class="modal-header">
				<h5 class="modal-title">編集前情報</h5>
			</div>
			<div class="form-group row align-items-center">
				<label class="col-sm-2 col-form-label text-center">社名</label>
				<div class="col-sm-10" id="modal_company"></div>

				<label class="col-sm-2 col-form-label text-center">氏名</label>
				<div class="col-sm-4" id="modal_name"></div>

				<label class="col-sm-2 col-form-label text-center">役職</label>
				<div class="col-sm-4" id="modal_position"></div>

				<label class="col-sm-2 col-form-label text-center">電話番号</label>
				<div class="col-sm-10" id="modal_phone"></div>
			</div>
			<div class="modal-footer"></div>

			<!-- 入力欄 -->
			<form action="edit" method="post">
				<div class="modal-header">
					<h5 class="modal-title">変更情報入力</h5>
				</div>
				<!--変更するデータのlist_idをセット-->
				<input type="hidden" id="edit_id" name="listId">

				<div class="form-group row align-items-center">

					<label class="col-sm-2 col-form-label text-center">社名</label>
					<div class="col-sm-10">
						<input type="text" class="form-control form-control-sm input-mid" id="edit_company" name="companyName">
					</div>
				</div>

				<div class="form-group row align-items-center">
					<label class="col-sm-2 col-form-label text-center">氏名</label>
					<div class="col-sm-4">
						<input type="text" class="form-control form-control-sm input-small" id="edit_name" name="personName">
					</div>
					<label class="col-sm-2 col-form-label text-center">役職</label>
					<div class="col-sm-4">
						<select class="form-control form-control-sm" id="edit_position" name="honolific">
							<option value="" selected>選択してください</option>
							<option>ー</option>
							<option>さん</option>
							<option>主任</option>
							<option>上級主任</option>
							<option>課長</option>
							<option>所長</option>
						</select>
					</div>
				</div>

				<div class="form-group row align-items-center">
					<label class="col-sm-2 col-form-label text-center">電話番号</label>
					<div class="col-sm-10">
						<input type="text" class="form-control form-control-sm input-mid" id="edit_phone" name="telNumber">
					</div>
				</div>
			</form>

			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" id="close_btn">キャンセル</button>
				<button type="button" class="btn btn-primary" id="save_btn">変更</button>
			</div>
		</div>
	</div>
</div>

<script>
	// 編集モーダル
	const modal = document.getElementById('edit_modal');
	// 「編集」ボタン
	const saveBtn = document.getElementById('save_btn');
	// 「キャンセル」ボタン
	const closeBtn = document.getElementById('close_btn');
	// main.htmlで定義しているクラス(左右半分に画面を分けるためのクラス)
	const panels = document.querySelectorAll('.panel');
	// 選択した行(tr)の情報を格納する変数
	let selectedRow = null;
	// モーダルの変更前情報を表示する要素
	const modalCompany = document.getElementById('modal_company');
	const modalName = document.getElementById('modal_name');
	const modalPosition = document.getElementById('modal_position');
	const modalPhone = document.getElementById('modal_phone');
	
	// aタグクリックでモーダル表示
	document.querySelectorAll('.open_edit_modal').forEach(link => {
		link.addEventListener('click', (e) => {
			e.preventDefault(); // ページ遷移防止
			selectedRow = link.closest('tr'); // 親のtrを取得
			// モーダルの変更前情報に値を格納
			modalCompany.textContent = selectedRow.cells[1].textContent;
			modalName.textContent = selectedRow.cells[2].textContent;
			modalPosition.textContent = selectedRow.cells[3].textContent;
			modalPhone.textContent = selectedRow.cells[4].textContent;
			// 変更するIDをformにセット
			document.getElementById('edit_id').value = link.dataset.id;
			// display属性をblockに変え、表示させる
			modal.style.display = 'block';
			panels.forEach(panel => panel.style.pointerEvents = 'none');
		});
	});

	// 変更ボタンでデータ更新(確認ダイアログで確認)
	saveBtn.addEventListener('click', () => {
		// 入力チェック
		const company = document.getElementById('edit_company').value;
		const name = document.getElementById('edit_name').value;
		const position = document.getElementById('edit_position').value;
		const phone = document.getElementById('edit_phone').value;

		// 会社名に TB が含まれるか（大文字小文字対応）
		const isTB = company.toUpperCase().includes("TB");

		// ★追加：電話番号が全角ハイフンのみかどうか
		const isFullWidthHyphenOnly = /^[ー]+$/.test(phone);
			
		// 登録処理を自動に設定
		document.getElementById('registMode').value = 2;

		// --- 未入力チェック ---
		const missing = [];
		if (!company) missing.push('社名');
		if (!name) missing.push('氏名');
		if (!position) missing.push('役職');

		// TB以外 → 電話番号必須
		// ★修正：TB以外 → 全角ハイフンのみ も 未入力扱い
	    if (!isTB && (!phone || isFullWidthHyphenOnly)) {
	        missing.push('電話番号');
	    }

		if (missing.length > 0) {
		    alert(missing.join('、') + 'を入力してください.');
			e.preventDefault();
		    return;
		}
		// 確認ダイアログ
		showDialog('相手先情報を変更しますか？', () => {
        		// 編集フォーム送信
	        const form = document.querySelector('form[action="edit"]');
	        form.submit();
	    });
	});

	// 閉じるボタン
	closeBtn.addEventListener('click', () => {
		// 入力値を初期化
		document.getElementById('edit_company').value='';
		document.getElementById('edit_name').value='';
		document.getElementById('edit_phone').value='';
		// 現在の選択肢をクリア
		editPositionSelect.innerHTML = "";
		const editOption = document.createElement("option");

        editOption.textContent = "ー";
        editOption.value = "ー";
        editPositionSelect.appendChild(editOption);
        editPositionSelect.disabled = true;
		// hidden inputを追加（まだなければ）
	    if (!editHiddenHonolific) {
	        editHiddenHonolific = document.createElement("input");
	        editHiddenHonolific.type = "hidden";
	        editHiddenHonolific.name = "honolific";
	        editHiddenHonolific.value = "ー"; // DB登録用の値
	        editPositionSelect.parentNode.appendChild(editHiddenHonolific);
	    }
		modal.style.display = 'none';
		panels.forEach(panel => panel.style.pointerEvents = 'auto');
	});

	// 役職セレクトボックス
	const editCompanyInput = document.getElementById('edit_company');
	const editPositionSelect = document.getElementById('edit_position');
	// hidden inputを準備（最初は存在しないので後で追加）
	let editHiddenHonolific = null;

	// 役職の候補
	const TB_EDIT_OPTIONS = ["様", "さん", "主任", "上級主任", "課長", "所長"];

	function updateEditPositionOptions() {
	    const editValue = editCompanyInput.value.trim().toUpperCase();

	    const editIsTB = editValue.includes("TB");

	    // 現在の選択肢をクリア
	    editPositionSelect.innerHTML = "";

	    if (editIsTB) {
	        // TB → 全候補を追加・選択可能
	        TB_EDIT_OPTIONS.forEach(opt => {
	            const editOption = document.createElement("option");
	            editOption.textContent = opt;
	            editOption.value = opt;
	            editPositionSelect.appendChild(editOption);
	        });

	        editPositionSelect.disabled = false;

			// hiddenがあれば削除
	        if (editHiddenHonolific) {
	            editHiddenHonolific.remove();
	            editHiddenHonolific = null;
	        }

	    } else {
	        // TB 以外 → 「ー」1つだけ・選択不可
	        const editOption = document.createElement("option");
	        editOption.textContent = "ー";
	        editOption.value = "ー";
	        editPositionSelect.appendChild(editOption);

	        editPositionSelect.disabled = true;

			// hidden inputを追加（まだなければ）
		    if (!editHiddenHonolific) {
		        editHiddenHonolific = document.createElement("input");
		        editHiddenHonolific.type = "hidden";
		        editHiddenHonolific.name = "honolific";
		        editHiddenHonolific.value = "ー"; // DB登録用の値
		        editPositionSelect.parentNode.appendChild(editHiddenHonolific);
		    }
	    }
	}

	// 社名入力のたびに実行
	editCompanyInput.addEventListener("input", updateEditPositionOptions);

	// 初期表示時
	window.addEventListener("DOMContentLoaded", updateEditPositionOptions);
</script>